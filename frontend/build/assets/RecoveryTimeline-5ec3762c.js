import{i as z,g as K,j as e}from"./index-2fe32897.js";import{r as y}from"./vendor-26c3c1d8.js";import{a as Z}from"./api-90359d14.js";import{R as U,C as X,c as q,X as V,Y as $,T as J,d as Q,B as ee,n as te,b as se}from"./ui-8425ddff.js";import"./three-f2a0a5ce.js";const j=(s,t,i)=>Math.max(t,Math.min(i,s)),k=s=>{const t=new Date(s);return isNaN(t.getTime())?String(s).slice(0,10):new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())).toISOString().slice(0,10)};function G(s){if(!s||s==="00:00")return null;const t=s.split(":");if(t.length<2)return null;const i=parseInt(t[0],10),n=parseInt(t[1],10);return isNaN(i)||isNaN(n)?null:i*60+n}function ie(s){const t=s?.sleep_duration_h;let i=0;if(typeof t=="number")i=t;else if(typeof t=="string"){const c=Number(t);!isNaN(c)&&isFinite(c)&&(i=c)}if(i&&i>0)return i;const n=G(s.sleep_onset_time),m=G(s.wake_time);if(n!==null&&m!==null){let c=m-n;return c<0&&(c+=24*60),Math.max(0,c)/60}return 0}function ne(s){const t=Number(s.recovery_score??0);if(t>0&&t<=100)return Math.round(t);const i=Number(s.hrv_night??0),n=Number(s.resting_hr??0),m=Number(s.sleep_duration_h??0),c=Number(s.spo2_night??0),h=Number(s.deep_sleep_pct??0),p=Number(s.rem_sleep_pct??0),f=i>0?j((i-35)/(80-35),0,1):0,g=n>0?j((75-n)/(75-45),0,1):0,v=m>0?j((m-6)/(8-6),0,1):0,S=c>0?j((c-94)/(99-94),0,1):0,_=20,d=18,r=h>0?j(h/_,0,1):0,l=p>0?j(p/d,0,1):0,b=(r+l)/2,M=.7*v+.3*b,A=f*.35+g*.25+M*.25+S*.15;return Math.round(A*100)}function w(s){return s.length?s.reduce((t,i)=>t+i,0)/s.length:0}function oe(s){if(s.length<2)return 0;const t=w(s),i=w(s.map(n=>(n-t)*(n-t)));return Math.sqrt(i)}function re(s){const t=w(s.slice(-7)),i=w(s.slice(-28));return i<=0?0:t/i}function B(s){const t=s.slice(-7),i=w(t),n=oe(t);return n===0?i>0?10:0:i/n}function ae(s){const t=s.slice(-7),i=w(t),n=B(s);return Math.round(i*n)}function ce(s){const t=Object.fromEntries((s||[]).map(h=>[String(h.gene).toUpperCase(),String(h.genotype)])),i=t.IL6?.includes("G")&&t.IL6?.includes("G")||t.TNF==="AA"||t.IL10==="CC",n=t.ADRB1==="AA"||t.COMT==="AA",m=t.CLOCK==="AA"||t.PER3==="long",c=t.ACTN3==="RR";return{inflammationSensitive:i,stressSensitive:n,circadianSensitive:m,powerDominant:c}}function E(s,t){let{acwr:i,monotony:n,strain:m}=s;return t.inflammationSensitive&&(i-=.1,m-=500),t.stressSensitive&&(n-=.3),t.circadianSensitive,{acwr:i,monotony:n,strain:m}}function de(s,t,i){const n=[],m=new Date,c=E({acwr:1.5,monotony:2,strain:6e3},i),h=t.acwr>=c.acwr||t.monotony>=c.monotony||t.strain>=c.strain,p=s<60;for(let f=1;f<=3;f++){const g=new Date(m);g.setDate(g.getDate()+f);const v=g.toLocaleDateString();h||p?n.push({day:v,focus:"Active Recovery + Skills",intensity:"Low",notes:"Mobility, soft-tissue, passing drills, walkthroughs. Avoid heavy contact."}):s<75?n.push({day:v,focus:i.powerDominant?"Speed & Technical":"Aerobic Conditioning",intensity:"Moderate",notes:i.powerDominant?"Short sprints, change-of-direction, limited contact":"Tempo runs, aerobic intervals"}):n.push({day:v,focus:"Full Rugby Conditioning",intensity:"High",notes:"Game simulation blocks, controlled contact, scrums/lineouts with volume caps"})}return n}const pe=({athleteId:s})=>{const[t,i]=y.useState(!0),[n,m]=y.useState(null),[c,h]=y.useState([]),[p,f]=y.useState([]),[g,v]=y.useState([]),[S,_]=y.useState(28);y.useEffect(()=>{let r=!1;return(async()=>{try{i(!0),m(null);let l=await Z(`/athletes/${s}/training-load`,{days:28,includeZeros:!0});l&&l.$values&&(l=l.$values);const b=(Array.isArray(l)?l:[]).map(a=>({date:a.date||a.Date,zoneWeightedLoad:Number(a.zoneWeightedLoad??a.ZoneWeightedLoad??0),metabolicPowerLoad:Number(a.metabolicPowerLoad??a.MetabolicPowerLoad??0),compositeLoad:Number(a.compositeLoad??a.CompositeLoad??a.load??0),zoneWeightedPerMin:Number(a.zoneWeightedPerMin??a.ZoneWeightedPerMin??0),metabolicPowerPerMin:Number(a.metabolicPowerPerMin??a.MetabolicPowerPerMin??0),compositePerMin:Number(a.compositePerMin??a.CompositePerMin??0)})),M=await z.getAllBiometricData(Number(s),void 0,void 0,1,200),A=await K.getGeneticProfileByAthlete(Number(s));r||(h(b),f(M||[]),v(A||[]))}catch{r||m("Failed to load recovery data")}finally{r||i(!1)}})(),()=>{r=!0}},[s]);const d=y.useMemo(()=>{const r=new Map;c.forEach(o=>{r.set(k(o.date),o)});const l=new Map,b=[...p].sort((o,x)=>new Date(o.date).getTime()-new Date(x.date).getTime());b.forEach(o=>l.set(k(o.date),o));const M=24*60*60*1e3;function A(o){if(l.has(o))return l.get(o);const x=new Date(o).getTime();let u,D=1/0;for(const P of b){const I=Math.abs(new Date(P.date).getTime()-x);I<D&&I<=M&&(u=P,D=I)}return u}const a=[],Y=Array.from(new Set([...c.map(o=>k(o.date)),...p.map(o=>k(o.date))])).sort();for(const o of Y){const x=r.get(o),u=A(o),D=u?ie(u):0,P=u?ne({...u,sleep_duration_h:D}):0;a.push({date:o,load:x?x.compositeLoad:0,recovery:P,sleepHours:D,hrv:Number(u?.hrv_night??0),restingHr:Number(u?.resting_hr??0)})}const H=a.slice(-S),R=re(a.map(o=>o.load)),L=B(a.map(o=>o.load)),T=ae(a.map(o=>o.load));let F=0;for(let o=H.length-1;o>=0;o--){const x=Number(H[o].recovery||0);if(x>0){F=x;break}}const W=ce(g),N=E({acwr:1.5,monotony:2,strain:6e3},W),O=de(F,{acwr:R,monotony:L,strain:T},W),C=[];return R>=N.acwr&&C.push(`ACWR high (${R.toFixed(2)} ≥ ${N.acwr.toFixed(2)})`),L>=N.monotony&&C.push(`Monotony high (${L.toFixed(2)} ≥ ${N.monotony.toFixed(2)})`),T>=N.strain&&C.push(`Strain high (${T.toFixed(0)} ≥ ${N.strain.toFixed(0)})`),F<60&&C.push("Low readiness (<60)"),{points:H,acwr:R,monotony:L,strain:T,latestRecovery:F,mods:W,thresholds:N,plan:O,flags:C}},[c,p,g,S]);return t?e.jsx("div",{className:"card-enhanced p-6 text-gray-600",children:"Loading recovery timeline..."}):n?e.jsxs("div",{className:"card-enhanced p-6 text-red-600",children:["Error: ",n]}):e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"card-enhanced p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-black",children:"Recovery Timeline & Coach Planner"}),e.jsx("p",{className:"text-gray-800",children:"Biometrics + Training Load + Genetics for rugby-specific decision support"})]}),e.jsx("div",{className:"flex gap-2",children:[7,14,28].map(r=>e.jsxs("button",{onClick:()=>_(r),className:`px-3 py-1 rounded ${S===r?"bg-purple-700 text-white":"bg-gray-200 text-gray-800"}`,children:[r,"d"]},r))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-purple-50 p-4 rounded",children:[e.jsx("div",{className:"text-xs text-gray-600",children:"ACWR (7d/28d)"}),e.jsx("div",{className:"text-2xl font-bold text-purple-700",children:d.acwr.toFixed(2)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Threshold: ",d.thresholds.acwr.toFixed(2)]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Acute: avg last 7 days load. Chronic: avg last 28 days load. ACWR = Acute / Chronic. Aim ≈ 0.8–1.3; spikes (",">","1.5) increase injury risk."]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded",children:[e.jsx("div",{className:"text-xs text-gray-600",children:"Monotony (7d)"}),e.jsx("div",{className:"text-2xl font-bold text-blue-700",children:d.monotony.toFixed(2)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Threshold: ",d.thresholds.monotony.toFixed(2)]}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Monotony = Mean(7d load) ÷ SD(7d load). Higher values mean repetitive loading; ",">","2.0 suggests increased injury risk."]})]}),e.jsxs("div",{className:"bg-amber-50 p-4 rounded",children:[e.jsx("div",{className:"text-xs text-gray-600",children:"Strain (7d mean × monotony)"}),e.jsx("div",{className:"text-2xl font-bold text-amber-700",children:d.strain.toFixed(0)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Threshold: ",d.thresholds.strain.toFixed(0)]}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Strain reflects total stress: Mean(7d load) × Monotony. High strain means high overall workload with low day-to-day variety."})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded",children:[e.jsx("div",{className:"text-xs text-gray-600",children:"Latest Readiness"}),e.jsxs("div",{className:"text-2xl font-bold text-green-700",children:[d.latestRecovery,"%"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Higher is better"}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Readiness combines HRV, Resting HR, Sleep hours, and SpO₂ into 0–100. Higher indicates better recovery capacity."})]})]}),e.jsx("div",{className:"h-80",children:e.jsx(U,{width:"100%",height:"100%",children:e.jsxs(X,{data:d.points,children:[e.jsx(q,{strokeDasharray:"3 3"}),e.jsx(V,{dataKey:"date"}),e.jsx($,{yAxisId:"left",orientation:"left"}),e.jsx($,{yAxisId:"recovery",orientation:"right",domain:[0,100],tick:{fill:"#0f766e"}}),e.jsx($,{yAxisId:"sleep",orientation:"right",domain:[0,12],tick:{fill:"#4338ca"},tickCount:7,width:40}),e.jsx(J,{}),e.jsx(Q,{}),e.jsx(ee,{yAxisId:"left",dataKey:"load",name:"Composite Load",fill:"#ef4444"}),e.jsx(te,{yAxisId:"recovery",type:"monotone",dataKey:"recovery",name:"Recovery %",stroke:"#10b981",fill:"#10b981",fillOpacity:.2,strokeWidth:2}),e.jsx(se,{yAxisId:"sleep",type:"monotone",dataKey:"sleepHours",name:"Sleep (h)",stroke:"#6366f1",strokeWidth:2,dot:{r:2}})]})})}),d.flags.length>0&&e.jsxs("div",{className:"mt-6 bg-red-50 border border-red-200 rounded p-4",children:[e.jsx("div",{className:"font-semibold text-red-700 mb-2",children:"Risk Flags"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.flags.map((r,l)=>e.jsx("span",{className:"px-2 py-1 bg-white border border-red-200 text-red-700 rounded text-sm",children:r},l))})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"col-span-2 bg-gray-50 rounded p-4",children:[e.jsx("div",{className:"font-semibold text-gray-800 mb-2",children:"Coach Plan: Next 3 Days"}),e.jsx("div",{className:"space-y-3",children:d.plan.map((r,l)=>e.jsxs("div",{className:"bg-white rounded border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-gray-800",children:r.day}),e.jsx("div",{className:`px-2 py-0.5 rounded text-xs ${r.intensity==="High"?"bg-red-100 text-red-700":r.intensity==="Moderate"?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700"}`,children:r.intensity})]}),e.jsx("div",{className:"text-sm text-gray-700 mt-1",children:r.focus}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:r.notes})]},l))})]}),e.jsxs("div",{className:"bg-white rounded border p-4",children:[e.jsx("div",{className:"font-semibold text-gray-800 mb-2",children:"Genetic Modifiers"}),e.jsxs("ul",{className:"text-sm text-gray-700 space-y-1",children:[e.jsxs("li",{children:["Inflammation sensitivity: ",d.mods.inflammationSensitive?"Yes":"No"]}),e.jsxs("li",{children:["Stress sensitivity: ",d.mods.stressSensitive?"Yes":"No"]}),e.jsxs("li",{children:["Circadian sensitivity: ",d.mods.circadianSensitive?"Yes":"No"]}),e.jsxs("li",{children:["Power-dominant (ACTN3 RR): ",d.mods.powerDominant?"Yes":"No"]})]}),e.jsx("div",{className:"mt-3 text-xs text-gray-500",children:"Thresholds are automatically adjusted by genetics to personalize risk."})]})]})]})})};export{pe as RecoveryTimeline,pe as default};
